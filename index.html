<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Pro 4.0 - Live Objection Trainer</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lexend:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ž</text></svg>">

    <!-- Libraries via CDN with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.1/dist/feather.min.js"></script>

    <style>
        :root {
            --color-background-base: #0A0A14; --color-background-elevated: #10101C; --color-surface-1: #141425; --color-surface-2: #1E1E33; --color-surface-3: #2A2A44; --color-surface-4: #383855; --color-border-subtle: #28283E; --color-border-default: #30304A; --color-border-strong: #4A4A6A; --color-text-primary: #F0F0F5; --color-text-secondary: #A0A0C0; --color-text-tertiary: #7A7A9A; --color-text-placeholder: #6A6A8A; --color-text-on-accent: #FFFFFF; --color-accent-primary: #6c47ff; --color-accent-primary-hover: #7d5eff; --color-accent-primary-active: #5b33ff; --color-accent-secondary: #00e0d3; --color-accent-tertiary: #00c6FF; --color-text-error: #F77272; --color-text-success: #57E092; --color-text-warning: #F5B85E; --color-text-info: var(--color-accent-tertiary); --color-white: #ffffff; --color-black: #000000;
            --color-accent-primary-rgb: 108, 71, 255; --color-background-base-rgb: 10, 10, 20; --color-shadow-rgb: 0, 0, 0;
            --gradient-primary: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-primary) 100%); --gradient-logo: linear-gradient(90deg, var(--color-accent-tertiary) 0%, var(--color-accent-secondary) 50%, var(--color-accent-primary) 100%);
            --spacing-xxs: 2px; --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 16px; --spacing-lg: 24px; --spacing-xl: 32px; --spacing-xxl: 48px;
            --border-radius-sm: 4px; --border-radius-md: 8px; --border-radius-lg: 12px; --border-radius-xl: 16px; --border-radius-full: 9999px;
            --transition-fast: all 0.2s ease-in-out; --transition-medium: all 0.3s ease-in-out;
            --shadow-xs: 0 1px 2px rgba(var(--color-shadow-rgb), 0.15); --shadow-sm: 0 2px 4px rgba(var(--color-shadow-rgb), 0.2); --shadow-md: 0 4px 10px rgba(var(--color-shadow-rgb), 0.25); --shadow-lg: 0 10px 20px rgba(var(--color-shadow-rgb), 0.25); --shadow-inner: inset 0 1px 3px rgba(var(--color-shadow-rgb), 0.1); --shadow-accent: 0 4px 15px rgba(var(--color-accent-primary-rgb), 0.25);
            --font-primary: 'Inter', sans-serif; --font-secondary: 'Lexend', sans-serif; --line-height-base: 1.6; --line-height-heading: 1.3;
            --z-index-sticky: 1100; --z-index-modal-backdrop: 1500; --z-index-toast: 2000; --z-index-loading: 2100;
            --input-height: 44px; --button-height: 44px; --container-max-width: 900px;
            --animation-spin: spin 1s linear infinite;
        }
        html[data-theme="light"] {
            --color-background-base: #F8F9FA; --color-background-elevated: #FFFFFF; --color-surface-1: #FFFFFF; --color-surface-2: #F1F3F5; --color-surface-3: #E9ECEF; --color-surface-4: #DEE2E6; --color-border-subtle: #E9ECEF; --color-border-default: #CED4DA; --color-border-strong: #ADB5BD; --color-text-primary: #212529; --color-text-secondary: #495057; --color-text-tertiary: #6C757D; --color-text-placeholder: #ADB5BD; --color-text-link: var(--color-accent-primary); --color-text-link-hover: var(--color-accent-primary-hover); --color-text-error: #D94848; --color-text-success: #2A9D8F; --color-text-warning: #E76F51; --color-text-info: #007BFF;
            --color-shadow-rgb: 108, 117, 125;
            --shadow-xs: 0 1px 2px rgba(var(--color-shadow-rgb), 0.05); --shadow-sm: 0 2px 4px rgba(var(--color-shadow-rgb), 0.07); --shadow-md: 0 4px 10px rgba(var(--color-shadow-rgb), 0.08); --shadow-lg: 0 10px 20px rgba(var(--color-shadow-rgb), 0.08); --shadow-inner: inset 0 1px 3px rgba(var(--color-shadow-rgb), 0.05); --shadow-accent: 0 4px 15px rgba(var(--color-accent-primary-rgb), 0.2);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; border-width: 0; border-style: solid; border-color: var(--color-border-default); }
        html { line-height: var(--line-height-base); -webkit-text-size-adjust: 100%; scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-primary); background-color: var(--color-background-base); color: var(--color-text-primary); line-height: inherit; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; min-height: 100vh; transition: background-color var(--transition-medium), color var(--transition-medium); }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-secondary); font-weight: 600; line-height: var(--line-height-heading); margin-bottom: var(--spacing-md); color: var(--color-text-primary); }
        h1 { font-size: clamp(2rem, 5vw, 2.75rem); } h2 { font-size: clamp(1.5rem, 4vw, 2rem); margin-top: var(--spacing-xl); } h3 { font-size: clamp(1.25rem, 3.5vw, 1.5rem); margin-top: var(--spacing-lg); }
        p { margin-bottom: var(--spacing-md); color: var(--color-text-secondary); max-width: 75ch; } p:last-child { margin-bottom: 0; }
        a { color: var(--color-text-link); text-decoration: none; } a:hover { color: var(--color-text-link-hover); text-decoration: underline; }
        ul, ol { list-style-position: inside; padding-left: var(--spacing-sm); margin-bottom: var(--spacing-md); }
        code { font-family: monospace; background-color: var(--color-surface-2); padding: var(--spacing-xxs) var(--spacing-xs); border-radius: var(--border-radius-sm); color: var(--color-text-secondary); }
        pre { padding: var(--spacing-md); overflow-x: auto; white-space: pre-wrap; border: 1px solid var(--color-border-subtle); background-color: var(--color-background-elevated); border-radius: var(--border-radius-md); margin-bottom: var(--spacing-md); }
        .ai-sales-pro-container { max-width: var(--container-max-width); margin: 0 auto; padding: var(--spacing-lg) var(--spacing-md); display: flex; flex-direction: column; min-height: 90vh; }
        .suite-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--spacing-md); padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--color-border-default); }
        .suite-title { font-size: 1.75rem; font-weight: 700; background: var(--gradient-logo); -webkit-background-clip: text; background-clip: text; color: transparent; user-select: none; margin: 0; display: inline-flex; align-items: center; gap: var(--spacing-sm); }
        .suite-title i.feather { width: 1.3em; height: 1.3em; stroke: url(#iconGradient); color: var(--color-accent-primary); background: none; -webkit-background-clip: unset; background-clip: unset; stroke-width: 2.5; }
        .theme-toggle { background: var(--color-surface-2); border: 1px solid var(--color-border-subtle); border-radius: var(--border-radius-full); padding: var(--spacing-xs); cursor: pointer; display: inline-flex; align-items: center; position: relative; transition: background-color var(--transition-fast); box-shadow: var(--shadow-inner); flex-shrink: 0; width: 44px; height: 44px; justify-content: center; }
        .theme-toggle:hover { background-color: var(--color-surface-3); }
        .theme-toggle__icon { width: 24px; height: 24px; color: var(--color-text-secondary); display: flex; align-items: center; justify-content: center; transition: color var(--transition-fast), transform 0.3s ease-out; z-index: 1; position: absolute; }
        html[data-theme="dark"] .theme-toggle__icon--sun { opacity: 0; transform: rotate(-90deg) scale(0.5); } html[data-theme="light"] .theme-toggle__icon--moon { opacity: 0; transform: rotate(90deg) scale(0.5); }
        html[data-theme="dark"] .theme-toggle__icon--moon { opacity: 1; transform: rotate(0deg) scale(1); color: var(--color-accent-tertiary); } html[data-theme="light"] .theme-toggle__icon--sun { opacity: 1; transform: rotate(0deg) scale(1); color: var(--color-warning); }
        .d-none { display: none !important; } .d-flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; } .justify-center { justify-content: center; } .justify-between { justify-content: space-between; } .gap-sm { gap: var(--spacing-sm); } .gap-md { gap: var(--spacing-md); } .gap-lg { gap: var(--spacing-lg); } .w-full { width: 100%; } .mt-xs { margin-top: var(--spacing-xs); } .mt-sm { margin-top: var(--spacing-sm); } .mt-md { margin-top: var(--spacing-md); } .mt-lg { margin-top: var(--spacing-lg); } .mb-md { margin-bottom: var(--spacing-md); } .mb-lg { margin-bottom: var(--spacing-lg); } .p-md { padding: var(--spacing-md); } .text-center { text-align: center; } .text-sm { font-size: 0.875rem; }
        .voice-trainer-panel { background-color: var(--color-background-elevated); border: 1px solid var(--color-border-default); border-radius: var(--border-radius-lg); padding: var(--spacing-lg) var(--spacing-xl); box-shadow: var(--shadow-lg); flex-grow: 1; display: flex; flex-direction: column; }
        .panel-header { display: flex; align-items: flex-start; gap: var(--spacing-md); margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 1px solid var(--color-border-subtle); }
        .panel-icon { width: 48px; height: 48px; background: var(--color-surface-2); border-radius: var(--border-radius-md); display: flex; align-items: center; justify-content: center; color: var(--color-accent-tertiary); flex-shrink: 0; box-shadow: var(--shadow-sm); }
        .panel-icon i.feather { width: 1.75rem; height: 1.75rem; stroke-width: 1.5; }
        .panel-header-content { flex-grow: 1; }
        .panel-header-content h3 { margin: 0 0 var(--spacing-xs) 0; font-size: 1.3rem; line-height: 1.2; color: var(--color-text-primary); }
        .panel-header-content p { margin: 0; color: var(--color-text-secondary); font-size: 0.95rem; max-width: 65ch; }
        .how-to-use-section { margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--color-border-subtle); padding-bottom: var(--spacing-lg); }
        .toggle-how-to-btn { color: var(--color-text-secondary); } .toggle-how-to-btn:hover { color: var(--color-text-primary); background-color: var(--color-surface-3); }
        .how-to-content { background-color: var(--color-surface-2); padding: var(--spacing-md); border-radius: var(--border-radius-md); margin-top: var(--spacing-sm); border: 1px solid var(--color-border-subtle); }
        .how-to-content h4 { font-size: 1.1rem; color: var(--color-text-primary); margin-top: 0; margin-bottom: var(--spacing-md); }
        .how-to-content p, .how-to-content ul { color: var(--color-text-secondary); font-size: 0.9rem; } .how-to-content ul { padding-left: var(--spacing-lg); } .how-to-content li { margin-bottom: var(--spacing-xs); }
        .how-to-content .code-highlight { color: var(--color-accent-tertiary); font-family: monospace; background-color: var(--color-surface-3); padding: 2px 4px; border-radius: 3px;}
        .btn { font-family: var(--font-secondary); font-weight: 600; font-size: 0.95rem; min-height: var(--button-height); height: var(--button-height); padding: 0 var(--spacing-lg); border-radius: var(--border-radius-lg); cursor: pointer; border: 1px solid transparent; transition: var(--transition-fast); display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); text-decoration: none; line-height: 1; user-select: none; outline: none; }
        .btn:focus-visible { outline: 2px solid var(--color-accent-tertiary); outline-offset: 2px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed !important; filter: grayscale(50%); transform: none !important; box-shadow: none !important; }
        .btn i.feather { width: 1.1em; height: 1.1em; stroke-width: 2.5; }
        .btn-primary { background: var(--gradient-primary); color: var(--color-text-on-accent); box-shadow: var(--shadow-accent); border: none; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 20px rgba(var(--color-accent-primary-rgb), 0.3); filter: brightness(1.1); }
        .btn-secondary { background: var(--color-surface-2); color: var(--color-text-primary); border: 1px solid var(--color-border-default); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover:not(:disabled) { background: var(--color-surface-3); border-color: var(--color-border-strong); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-danger { background: var(--color-text-error); color: var(--color-white); border-color: var(--color-text-error); }
        .btn-danger:hover:not(:disabled) { background: #c0392b; border-color: #c0392b; }
        .btn-lg { min-height: 52px; height: 52px; padding: 0 var(--spacing-xl); font-size: 1.1rem; }
        .controls-section, .transcript-section, .status-section { margin-bottom: var(--spacing-xl); }
        #record-button { width: 80px; height: 80px; border-radius: 50%; font-size: 1.2rem; background-color: var(--color-surface-3); border-color: var(--color-border-strong); }
        #record-button:hover:not(:disabled) { background-color: var(--color-surface-4); }
        #record-button.recording { background: var(--color-text-error); color: var(--color-white); border-color: var(--color-text-error) }
        #record-button.recording:hover:not(:disabled) { background: #c0392b; }
        #record-button.recording i.feather { animation: pulseRecord 1.5s infinite ease-in-out; }
        @keyframes pulseRecord { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .status-bar { padding: var(--spacing-sm) var(--spacing-md); background-color: var(--color-surface-2); border-radius: var(--border-radius-md); border: 1px solid var(--color-border-subtle); font-weight: 500; text-align: center; color: var(--color-text-secondary); min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .status-bar.status-info { border-left: 4px solid var(--color-text-info); color: var(--color-text-info); }
        .status-bar.status-success { border-left: 4px solid var(--color-text-success); color: var(--color-text-success); }
        .status-bar.status-warning { border-left: 4px solid var(--color-text-warning); color: var(--color-text-warning); }
        .status-bar.status-error { border-left: 4px solid var(--color-text-error); color: var(--color-text-error); }
        #transcript-area { background-color: var(--color-surface-1); border: 1px solid var(--color-border-default); border-radius: var(--border-radius-md); padding: var(--spacing-md); height: 250px; overflow-y: auto; line-height: 1.7; }
        .transcript-message { margin-bottom: var(--spacing-sm); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--border-radius-sm); }
        .transcript-message strong { color: var(--color-text-primary); }
        .transcript-message.user { background-color: rgba(var(--color-accent-primary-rgb), 0.1); text-align: right; }
        .transcript-message.user strong { color: var(--color-accent-primary); }
        .transcript-message.ai { background-color: var(--color-surface-3); text-align: left; }
        .transcript-message.ai strong { color: var(--color-accent-tertiary); }
        .transcript-message.system { background-color: transparent; text-align: center; font-style: italic; color: var(--color-text-tertiary); font-size: 0.9em; padding: var(--spacing-xs) 0; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(var(--color-background-base-rgb), 0.85); backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: var(--z-index-loading); opacity: 0; pointer-events: none; transition: opacity var(--transition-medium); }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid var(--color-surface-3); border-top-color: var(--color-accent-tertiary); border-radius: 50%; animation: var(--animation-spin); margin-bottom: var(--spacing-md); }
        .loading-overlay p { color: var(--color-text-secondary); font-weight: 500; margin: 0; text-align: center; }
        .copy-toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 120px); background: var(--color-surface-3); color: var(--color-text-primary); padding: var(--spacing-md) var(--spacing-lg); border-radius: var(--border-radius-lg); font-weight: 500; font-size: 0.95rem; opacity: 0; transition: transform 0.4s cubic-bezier(0.215, 0.610, 0.355, 1), opacity 0.4s ease-out; z-index: var(--z-index-toast); box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: var(--spacing-md); border: 1px solid var(--color-border-default); border-left-width: 5px; }
        .copy-toast.success { border-left-color: var(--color-text-success); } .copy-toast.error { border-left-color: var(--color-text-error); } .copy-toast.info { border-left-color: var(--color-text-info); }
        .copy-toast .toast-icon { width: 1.3em; height: 1.3em; flex-shrink: 0; stroke-width: 2.5; }
        .copy-toast.show { transform: translate(-50%, 0); opacity: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) { html { font-size: 15px; } .ai-sales-pro-container { padding: var(--spacing-md); } .voice-trainer-panel { padding: var(--spacing-lg); } .controls-section .d-flex { flex-direction: column; align-items: center; } }
        @media (max-width: 480px) { html { font-size: 14px; } .suite-header { flex-direction: column; align-items: flex-start; } .voice-trainer-panel { padding: var(--spacing-md); } #transcript-area { height: 200px; } }
        .api-key-warning { background-color: rgba(245, 184, 94, 0.15); border: 1px solid var(--color-text-warning); color: var(--color-text-warning); padding: var(--spacing-md); border-radius: var(--border-radius-md); margin-top: var(--spacing-md); text-align: center; }
        #debug-console { background-color: var(--color-surface-1); border: 1px solid var(--color-border-default); border-radius: var(--border-radius-md); padding: var(--spacing-md); height: 120px; overflow-y: auto; margin-top: var(--spacing-md); font-family: monospace; font-size: 0.8rem; color: var(--color-text-secondary); display: none; }
        .debug-entry { margin-bottom: 4px; border-bottom: 1px solid var(--color-border-subtle); padding-bottom: 2px; }
        .debug-entry.error { color: var(--color-text-error); }
        .debug-entry.warning { color: var(--color-text-warning); }
        .debug-entry.success { color: var(--color-text-success); }
        .show-debug-toggle { font-size: 0.8rem; color: var(--color-text-tertiary); text-decoration: underline; cursor: pointer; margin-top: var(--spacing-sm); display: inline-block; }
        .connection-timer { font-size: 0.8rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs); text-align: center; }
    </style>
</head>
<body>

    <svg width="0" height="0" style="position:absolute">
      <defs>
        <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:var(--color-accent-tertiary); stop-opacity:1" />
          <stop offset="50%" style="stop-color:var(--color-accent-secondary); stop-opacity:1" />
          <stop offset="100%" style="stop-color:var(--color-accent-primary); stop-opacity:1" />
        </linearGradient>
      </defs>
    </svg>

    <div class="ai-sales-pro-container" id="ai-sales-pro-app">
        <header class="suite-header">
            <h1 class="suite-title"><i data-feather="mic"></i> AI Sales Pro 4.0</h1>
            <button type="button" class="theme-toggle" id="theme-toggle-btn" aria-label="Toggle theme">
                <span class="theme-toggle__icon theme-toggle__icon--sun"><i data-feather="sun"></i></span>
                <span class="theme-toggle__icon theme-toggle__icon--moon"><i data-feather="moon"></i></span>
            </button>
        </header>

        <main id="suite-panels-container">
            <section class="voice-trainer-panel" id="panel-voice-trainer">
                <div class="panel-header">
                    <div class="panel-icon"><i data-feather="message-circle"></i></div>
                    <div class="panel-header-content">
                        <h3>Live AI Objection Trainer</h3>
                        <p>Practice handling difficult customer objections in real-time with an AI-powered voice agent.</p>
                    </div>
                </div>

                <div class="how-to-use-section">
                    <button type="button" class="btn btn-secondary btn-sm toggle-how-to-btn" aria-expanded="false" aria-controls="how-to-voice-trainer" style="height: auto; min-height: auto; padding: var(--spacing-sm) var(--spacing-md);">
                        <i data-feather="help-circle"></i> How to Use
                    </button>
                    <div class="how-to-content d-none" id="how-to-voice-trainer">
                        <h4>Using the AI Trainer:</h4>
                        <ol>
                            <li><strong>Start Call:</strong> Click the "Start Call" button. This will connect to the AI agent.
                                <br><em>The AI should begin speaking its opening line automatically.</em>
                            </li>
                            <li><strong>Microphone Permission:</strong> Your browser will ask for permission to use your microphone if it hasn't already been granted for this site. Please allow it.</li>
                            <li><strong>Speak Your Response:</strong> After the AI finishes speaking, the <i data-feather="mic" style="width:1em; height:1em; vertical-align:text-bottom;"></i> Microphone button will become active. Click it (it turns red). Speak your response.</li>
                            <li><strong>Stop Recording:</strong> Click the Microphone button again (it shows a <i data-feather="square" style="width:1em; height:1em; vertical-align:text-bottom;"></i> icon). Your speech is sent to the AI.</li>
                            <li><strong>Listen & Repeat:</strong> The AI agent will respond. The conversation appears in the transcript area.</li>
                            <li><strong>End Call:</strong> Click "End Call" when finished.</li>
                        </ol>
                        <p class="text-sm text-tertiary mt-md">
                            <strong>Troubleshooting:</strong> If issues occur:
                        </p>
                        <ul>
                            <li>Check the debug console (F12 -> Console) for error messages.</li>
                            <li>Ensure your browser allows WebSocket connections and microphone access.</li>
                            <li>Verify a stable internet connection.</li>
                            <li>If embedded in an environment with restrictions, check for related issues.</li>
                        </ul>
                        <p class="text-sm mt-md" style="color: var(--color-text-warning);">
                            <strong>Note:</strong> The necessary API configurations for ElevenLabs are handled internally by this tool.
                        </p>
                    </div>
                </div>

                <section class="controls-section text-center" style="margin-top: var(--spacing-lg);">
                    <div class="d-flex justify-center items-center gap-lg">
                        <button type="button" id="start-call-btn" class="btn btn-primary btn-lg">
                            <i data-feather="phone-call"></i> Start Call
                        </button>
                        <button type="button" id="record-button" class="btn btn-secondary" disabled>
                            <i data-feather="mic"></i>
                        </button>
                        <button type="button" id="end-call-btn" class="btn btn-danger btn-lg" disabled>
                            <i data-feather="phone-off"></i> End Call
                        </button>
                    </div>
                </section>

                <section class="status-section">
                    <div id="status-bar" class="status-bar">Trainer Idle. Click "Start Call" to begin.</div>
                    <div class="connection-timer" id="connection-timer"></div>
                </section>

                <section class="transcript-section flex-col flex-grow">
                    <h4 class="mb-sm">Conversation Transcript</h4>
                    <div id="transcript-area" class="flex-grow">
                        <!-- Messages will appear here -->
                    </div>
                    <a href="#" class="show-debug-toggle" id="toggle-debug">Show/Hide Debug Console</a>
                    <div id="debug-console">
                        <!-- Debug messages will appear here -->
                    </div>
                </section>

                <audio id="ai-audio-player" hidden></audio>
            </section>
        </main>
    </div>

    <div class="loading-overlay" id="loading-overlay" aria-hidden="true" role="alert" aria-live="assertive">
        <div class="loading-spinner"></div>
        <p>Processing...</p>
    </div>

    <div class="copy-toast" id="toast-notification" role="status" aria-live="polite">
        <i data-feather="info" class="toast-icon"></i>
        <span id="toast-message">Notification</span>
    </div>

    <script>
        'use strict';

        const THEME_KEY_LS = 'aiSalesPro4_theme_hardcoded_v4_public_final';
        const HARDCODED_VOICE_ID = 'nGANIuCPLd6iMHN29kJp';
        const ELEVENLABS_API_KEY = 'sk_3813e5cdafb1f36254ab1f4677b63e35aa26c5ec080d2253';
        const ELEVENLABS_WEBSOCKET_URL = `wss://api.elevenlabs.io/v1/convai/conversation?agent_id=${HARDCODED_VOICE_ID}`;
        const ELEVENLABS_MODEL_ID = 'eleven_turbo_v2';
        const CONNECTION_TIMEOUT = 15000;

        let appState = {
            currentTheme: 'dark',
            toastTimeout: null,
            elevenLabsApiKey: ELEVENLABS_API_KEY,
            elevenLabsVoiceId: HARDCODED_VOICE_ID,
            websocket: null,
            isSessionActive: false,
            isListening: false,
            isAISpeaking: false,
            audioQueue: [],
            audioPlayer: null,
            speechRecognizer: null,
            finalTranscript: '',
            showDebug: false,
            connectionTimer: null,
            connectionStartTime: 0,
            connectionTimeout: null,
        };

        const $ = (selector) => document.querySelector(selector);
        const elements = {
            themeToggleBtn: $('#theme-toggle-btn'),
            loadingOverlay: $('#loading-overlay'),
            loadingOverlayText: $('#loading-overlay p'),
            toastNotification: $('#toast-notification'),
            toastIconElement: () => elements.toastNotification.querySelector('.toast-icon'),
            toastMessage: $('#toast-message'),
            startCallBtn: $('#start-call-btn'),
            recordBtn: $('#record-button'),
            endCallBtn: $('#end-call-btn'),
            statusBar: $('#status-bar'),
            transcriptArea: $('#transcript-area'),
            aiAudioPlayer: $('#ai-audio-player'),
            howToToggleBtn: $('.toggle-how-to-btn'), 
            howToContent: $('#how-to-voice-trainer'),
            debugConsole: $('#debug-console'),
            toggleDebugBtn: $('#toggle-debug'),
            connectionTimer: $('#connection-timer')
        };

        function _replaceFeatherIcons(specificElements) {
            if (typeof feather !== 'undefined' && feather && typeof feather.replace === 'function') {
                try {
                    if (specificElements) {
                        feather.replace({ class: Array.from(specificElements) });
                    } else {
                        feather.replace();
                    }
                } catch (e) {
                    logDebug(`Feather icon replacement error: ${e.message}`, 'error');
                }
            } else {
                logDebug('Feather library not available for icon replacement.', 'warning');
            }
        }

        const logDebug = (message, type = 'info') => {
            if (appState.showDebug || type === 'error' || type === 'warning') {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
            if (!elements.debugConsole || !appState.showDebug) return;
            const entry = document.createElement('div');
            entry.classList.add('debug-entry');
            if (type !== 'info') entry.classList.add(type);
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            elements.debugConsole.appendChild(entry);
            elements.debugConsole.scrollTop = elements.debugConsole.scrollHeight;
        };

        const toggleDebugConsole = () => {
            if (!elements.debugConsole) return;
            appState.showDebug = !appState.showDebug;
            elements.debugConsole.style.display = appState.showDebug ? 'block' : 'none';
            logDebug(`Debug console ${appState.showDebug ? 'shown' : 'hidden'}.`, 'info');
        };

        const toggleLoading = (show, message = 'Processing...') => {
            if (!elements.loadingOverlay || !elements.loadingOverlayText) return;
            elements.loadingOverlayText.textContent = message;
            elements.loadingOverlay.classList.toggle('active', show);
            elements.loadingOverlay.setAttribute('aria-hidden', String(!show));
        };

        const showToast = (message, type = 'info', duration = 3500) => {
            if (!elements.toastNotification || !elements.toastMessage) return;
            clearTimeout(appState.toastTimeout);
            elements.toastMessage.textContent = message;
            elements.toastNotification.className = 'copy-toast';
            elements.toastNotification.classList.add(type);
            let iconName = 'info';
            if (type === 'success') iconName = 'check-circle';
            else if (type === 'error') iconName = 'alert-circle';
            else if (type === 'warning') iconName = 'alert-triangle';
            const currentIconElement = elements.toastIconElement();
            if (currentIconElement) {
                currentIconElement.setAttribute('data-feather', iconName);
                _replaceFeatherIcons([currentIconElement]);
            }
            requestAnimationFrame(() => elements.toastNotification.classList.add('show'));
            appState.toastTimeout = setTimeout(() => elements.toastNotification.classList.remove('show'), duration);
        };

        const updateStatus = (message, type = 'info') => {
            if (!elements.statusBar) return;
            elements.statusBar.textContent = message;
            elements.statusBar.className = 'status-bar';
            if (type) elements.statusBar.classList.add(`status-${type}`);
        };

        const addMessageToTranscript = (speaker, text, type = 'message') => {
            if (!elements.transcriptArea) return;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('transcript-message');
            if (type === 'system') {
                messageDiv.classList.add('system');
                messageDiv.innerHTML = `<em>${escapeHtml(text)}</em>`;
            } else {
                messageDiv.classList.add(speaker.toLowerCase());
                messageDiv.innerHTML = `<strong>${escapeHtml(speaker)}:</strong> ${escapeHtml(text)}`;
            }
            elements.transcriptArea.appendChild(messageDiv);
            elements.transcriptArea.scrollTop = elements.transcriptArea.scrollHeight;
        };

        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'");
        };

        const initializeTheme = () => {
            const savedTheme = localStorage.getItem(THEME_KEY_LS);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            appState.currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', appState.currentTheme);
        };

        const toggleTheme = () => {
            appState.currentTheme = appState.currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', appState.currentTheme);
            localStorage.setItem(THEME_KEY_LS, appState.currentTheme);
        };

        const initializeSpeechRecognition = () => {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) {
                updateStatus('Speech recognition not supported. Try Chrome.', 'error');
                showToast('Speech recognition not supported. Try Chrome.', 'error', 5000);
                logDebug('Speech Recognition API not supported by this browser.', 'error');
                if (elements.recordBtn) elements.recordBtn.disabled = true;
                return false;
            }

            appState.speechRecognizer = new SpeechRecognition();
            appState.speechRecognizer.interimResults = true;
            appState.speechRecognizer.continuous = true;
            appState.speechRecognizer.lang = 'en-US';

            appState.speechRecognizer.onresult = (event) => {
                let interimTranscript = '';
                appState.finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        appState.finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };

            appState.speechRecognizer.onend = () => {
                logDebug("Speech recognition ended.", 'info');
                appState.isListening = false;
                if (elements.recordBtn) {
                    elements.recordBtn.classList.remove('recording');
                    elements.recordBtn.innerHTML = '<i data-feather="mic"></i>';
                    _replaceFeatherIcons([elements.recordBtn.querySelector('i')]);
                }

                if (appState.finalTranscript.trim() && appState.websocket && appState.websocket.readyState === WebSocket.OPEN) {
                    addMessageToTranscript('You', appState.finalTranscript.trim());
                    sendUserUtteranceToElevenLabs(appState.finalTranscript.trim());
                } else if (!appState.finalTranscript.trim() && appState.isSessionActive) {
                    updateStatus('No speech detected. Click microphone to try again.', 'warning');
                }

                if (appState.isSessionActive && !appState.isAISpeaking) {
                    if (elements.recordBtn) elements.recordBtn.disabled = false;
                }
            };

            appState.speechRecognizer.onerror = (event) => {
                logDebug(`Speech Recognition Error: ${event.error}`, 'error');
                appState.isListening = false;
                if (elements.recordBtn) {
                    elements.recordBtn.classList.remove('recording');
                    elements.recordBtn.innerHTML = '<i data-feather="mic"></i>';
                    _replaceFeatherIcons([elements.recordBtn.querySelector('i')]);
                    elements.recordBtn.disabled = (appState.isSessionActive && !appState.isAISpeaking) ? false : true;
                }
                let errorMsg = 'Speech recognition error';
                if (event.error === 'no-speech') errorMsg = 'No speech was detected.';
                else if (event.error === 'audio-capture') errorMsg = 'Microphone problem. Check permissions.';
                else if (event.error === 'not-allowed') errorMsg = 'Microphone access denied by user/browser.';
                else errorMsg = `Error: ${event.error}`;
                updateStatus(errorMsg, 'error');
                showToast(errorMsg, 'error');
            };

            logDebug('Speech Recognition initialized successfully.', 'success');
            return true;
        };

        const toggleRecording = () => {
            if (!appState.isSessionActive || !appState.speechRecognizer || appState.isAISpeaking) {
                logDebug("Recording toggle failed: Session inactive, no recognizer, or AI speaking.", 'warning');
                return;
            }

            if (appState.isListening) {
                logDebug("Stopping speech recognition.", 'info');
                appState.speechRecognizer.stop();
            } else {
                logDebug("Attempting to start speech recognition.", 'info');
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        appState.finalTranscript = '';
                        appState.speechRecognizer.start();
                        appState.isListening = true;
                        if (elements.recordBtn) {
                            elements.recordBtn.classList.add('recording');
                            elements.recordBtn.innerHTML = '<i data-feather="square"></i>';
                            _replaceFeatherIcons([elements.recordBtn.querySelector('i')]);
                        }
                        updateStatus('Listening... Speak now.', 'info');
                    })
                    .catch(err => {
                        logDebug(`Microphone access error: ${err.name} - ${err.message || err}`, 'error');
                        let userMessage = 'Microphone access error.';
                        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                            userMessage = 'Microphone access denied. Please enable it in browser settings.';
                        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                            userMessage = 'No microphone found. Please connect a microphone.';
                        }
                        updateStatus(userMessage, 'error');
                        showToast(userMessage, 'error', 5000);
                        if (elements.recordBtn) elements.recordBtn.disabled = (appState.isSessionActive && !appState.isAISpeaking) ? false : true;
                    });
            }
        };

        const startConnectionTimer = () => {
            appState.connectionStartTime = Date.now();
            appState.connectionTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - appState.connectionStartTime) / 1000);
                elements.connectionTimer.textContent = `Connection time: ${elapsed}s`;
            }, 1000);
            appState.connectionTimeout = setTimeout(() => {
                if (!appState.isSessionActive) {
                    logDebug('Connection timed out.', 'error');
                    updateStatus('Connection timed out. Please try again.', 'error');
                    showToast('Connection timed out. Please try again.', 'error');
                    endCall(false);
                }
            }, CONNECTION_TIMEOUT);
        };

        const clearConnectionTimer = () => {
            if (appState.connectionTimer) {
                clearInterval(appState.connectionTimer);
                appState.connectionTimer = null;
            }
            if (appState.connectionTimeout) {
                clearTimeout(appState.connectionTimeout);
                appState.connectionTimeout = null;
            }
            elements.connectionTimer.textContent = '';
        };

        // Fetches the signed, time-limited WebSocket URL
        async function getSignedUrl() {
            try {
                const resp = await fetch(
                    `https://api.elevenlabs.io/v1/convai/conversation/get_signed_url?agent_id=${appState.elevenLabsVoiceId}`,
                    { headers: { 'xi-api-key': appState.elevenLabsApiKey } }
                );
                if (!resp.ok) {
                    throw new Error(`HTTP error! Status: ${resp.status}`);
                }
                const data = await resp.json();
                if (!data.signed_url) {
                    throw new Error('Signed URL not provided in response');
                }
                return data.signed_url;
            } catch (error) {
                logDebug(`Failed to fetch signed URL: ${error.message}`, 'error');
                throw error;
            }
        }

        const startCall = async () => {
            logDebug("startCall function invoked", 'info');
            if (!appState.elevenLabsApiKey) {
                showToast('API key is missing.', 'error');
                return;
            }
            if (appState.isSessionActive) {
                showToast('Call is already active.', 'warning');
                return;
            }
            toggleLoading(true, 'Starting call...');
            updateStatus('Connecting to AI Agent...', 'info');
            if (elements.transcriptArea) elements.transcriptArea.innerHTML = '';
            addMessageToTranscript('System', 'Attempting to connect to AI agent...', 'system');
            try {
                const wsUrl = await getSignedUrl();
                appState.websocket = new WebSocket(wsUrl);
                appState.audioQueue = [];
                startConnectionTimer();
                appState.websocket.onopen = () => {
                    logDebug("WebSocket connection opened.", 'success');
                    toggleLoading(false);
                    clearConnectionTimer();
                    appState.isSessionActive = true;
                    updateStatus('Connected! AI Agent is initiating...', 'success');
                    addMessageToTranscript('System', 'Connection successful. Waiting for AI...', 'system');
                    if (elements.startCallBtn) elements.startCallBtn.disabled = true;
                    if (elements.endCallBtn) elements.endCallBtn.disabled = false;
                    if (elements.recordBtn) elements.recordBtn.disabled = false; // Unlock mic immediately
                };
                appState.websocket.onmessage = (event) => {
                    let response;
                    try {
                        response = JSON.parse(event.data);
                    } catch (e) {
                        logDebug(`Error parsing WS message: ${e.message}`, 'error');
                        return;
                    }
                    if (response.audio) {
                        appState.audioQueue.push(response.audio);
                        if (!appState.isAISpeaking && appState.audioQueue.length > 0) {
                            appState.isAISpeaking = true;
                            updateStatus('AI is speaking...', 'info');
                            if (elements.recordBtn) elements.recordBtn.disabled = true;
                            playAudioFromQueue();
                        }
                    }
                    if (response.generated_text && response.generated_text.trim() !== "") {
                        addMessageToTranscript('AI', response.generated_text.trim());
                    }
                    if (response.error) {
                        logDebug(`ElevenLabs WS Error: ${JSON.stringify(response.error)}`, 'error');
                        let errDetail = response.error.message || JSON.stringify(response.error);
                        showToast(`AI Error: ${errDetail}`, 'error', 7000);
                        updateStatus(`AI Error: ${errDetail}`, 'error');
                        if (["forbidden_voice_id", "invalid_api_key", "setup_required_for_voice_chat", "voice_not_found"].includes(response.error.status)) {
                            addMessageToTranscript('System', `Critical AI Error: ${errDetail}. Ending call.`, 'system');
                            endCall(false);
                        }
                    }
                };
                appState.websocket.onerror = (error) => {
                    logDebug(`WebSocket Error: ${error.message || JSON.stringify(error)}`, 'error');
                    toggleLoading(false);
                    updateStatus('Failed to connect to AI agent.', 'error');
                    showToast('Failed to connect to AI agent.', 'error');
                    addMessageToTranscript('System', 'Connection failed.', 'system');
                    endCall(false);
                };
                appState.websocket.onclose = (event) => {
                    logDebug(`WebSocket Closed: Code=${event.code}, Reason=${event.reason}`, 'info');
                    if (appState.isSessionActive) {
                        updateStatus('Connection closed unexpectedly.', 'error');
                        showToast('Connection closed unexpectedly.', 'error');
                        addMessageToTranscript('System', 'Connection closed unexpectedly.', 'system');
                    }
                    appState.isSessionActive = false;
                    appState.isAISpeaking = false;
                    appState.audioQueue = [];
                    if (elements.aiAudioPlayer && elements.aiAudioPlayer.src) {
                        elements.aiAudioPlayer.pause();
                        elements.aiAudioPlayer.src = "";
                    }
                    clearConnectionTimer();
                };
            } catch (err) {
                logDebug(`WebSocket Setup Error: ${err.message}`, 'error');
                toggleLoading(false);
                updateStatus('Failed to initialize connection.', 'error');
                showToast('Failed to initialize connection.', 'error');
                addMessageToTranscript('System', 'Failed to initialize connection.', 'system');
            }
        };

        const sendUserUtteranceToElevenLabs = (text) => {
            if (!appState.websocket || appState.websocket.readyState !== WebSocket.OPEN) {
                logDebug('WebSocket not open. Cannot send utterance.', 'error');
                updateStatus('Connection lost. Please restart the call.', 'error');
                showToast('Connection lost. Please restart the call.', 'error');
                endCall(false);
                return;
            }
            const message = {
                text: text,
                try_trigger_generation: true
            };
            appState.websocket.send(JSON.stringify(message));
            logDebug(`Sent utterance to ElevenLabs: ${text}`, 'info');
            updateStatus('Waiting for AI response...', 'info');
        };

        const endCall = (sendCloseMessage = true) => {
            logDebug(`endCall (sendCloseMessage: ${sendCloseMessage})`, 'info');
            clearConnectionTimer();
            if (appState.speechRecognizer && appState.isListening) {
                appState.speechRecognizer.abort();
                appState.isListening = false;
            }
            const wasActive = appState.isSessionActive;
            appState.isSessionActive = false;
            if (appState.websocket) {
                if (sendCloseMessage && appState.websocket.readyState === WebSocket.OPEN) {
                    try {
                        appState.websocket.send(JSON.stringify({ "terminate_session": true }));
                    } catch (e) {
                        logDebug(`Error sending terminate message: ${e.message}`, 'error');
                    }
                }
                appState.websocket.close(1000, "User ended call");
                appState.websocket = null;
            }
            appState.isAISpeaking = false;
            appState.audioQueue = [];
            if (elements.aiAudioPlayer && elements.aiAudioPlayer.src) {
                elements.aiAudioPlayer.pause();
                elements.aiAudioPlayer.src = "";
            }
            if (wasActive) {
                updateStatus('Call ended.', 'info');
                addMessageToTranscript('System', 'Call ended by user.', 'system');
            }
            if (elements.startCallBtn) elements.startCallBtn.disabled = false;
            if (elements.endCallBtn) elements.endCallBtn.disabled = true;
            if (elements.recordBtn) {
                elements.recordBtn.disabled = true;
                elements.recordBtn.classList.remove('recording');
                elements.recordBtn.innerHTML = '<i data-feather="mic"></i>';
                _replaceFeatherIcons([elements.recordBtn.querySelector('i')]);
            }
        };

        const playAudioFromQueue = async () => {
            if (!appState.audioQueue.length || !elements.aiAudioPlayer) {
                appState.isAISpeaking = false;
                if (elements.recordBtn && appState.isSessionActive) elements.recordBtn.disabled = false;
                updateStatus('Waiting for your response...', 'info');
                return;
            }
            const audioBase64 = appState.audioQueue.shift();
            try {
                const audioData = `data:audio/mp3;base64,${audioBase64}`;
                elements.aiAudioPlayer.src = audioData;
                await elements.aiAudioPlayer.play();
                elements.aiAudioPlayer.onended = () => {
                    appState.isAISpeaking = false;
                    if (appState.audioQueue.length > 0) {
                        playAudioFromQueue();
                    } else {
                        if (elements.recordBtn && appState.isSessionActive) elements.recordBtn.disabled = false;
                        updateStatus('Waiting for your response...', 'info');
                    }
                };
                elements.aiAudioPlayer.onerror = (e) => {
                    logDebug(`Audio playback error: ${e.message || JSON.stringify(e)}`, 'error');
                    appState.isAISpeaking = false;
                    if (elements.recordBtn && appState.isSessionActive) elements.recordBtn.disabled = false;
                    updateStatus('Error playing AI response.', 'error');
                    showToast('Error playing AI response.', 'error');
                };
            } catch (err) {
                logDebug(`Audio setup error: ${err.message}`, 'error');
                appState.isAISpeaking = false;
                if (elements.recordBtn && appState.isSessionActive) elements.recordBtn.disabled = false;
                updateStatus('Error playing AI response.', 'error');
                showToast('Error playing AI response.', 'error');
            }
        };

        const initializeTrainer = () => {
            logDebug("Initializing AI Sales Pro 4.0 (Public Version)...", 'info');
            initializeTheme();
            logDebug('Using hardcoded API Key and Voice ID.', 'info');

            const speechRecognitionInitialized = initializeSpeechRecognition();
            _replaceFeatherIcons();

            if (elements.aiAudioPlayer) appState.audioPlayer = elements.aiAudioPlayer;
            else logDebug("CRITICAL: AI Audio Player element not found.", 'error');

            if (elements.themeToggleBtn) elements.themeToggleBtn.addEventListener('click', toggleTheme);
            if (elements.startCallBtn) elements.startCallBtn.addEventListener('click', startCall);
            if (elements.recordBtn && speechRecognitionInitialized) elements.recordBtn.addEventListener('click', toggleRecording);
            else if (elements.recordBtn) elements.recordBtn.disabled = true;
            if (elements.endCallBtn) elements.endCallBtn.addEventListener('click', () => endCall(true));

            if (elements.toggleDebugBtn) elements.toggleDebugBtn.addEventListener('click', (e) => {
                e.preventDefault();
                toggleDebugConsole();
            });

            if (elements.howToToggleBtn && elements.howToContent) {
                elements.howToToggleBtn.addEventListener('click', () => {
                    const isExpanded = elements.howToToggleBtn.getAttribute('aria-expanded') === 'true';
                    elements.howToToggleBtn.setAttribute('aria-expanded', String(!isExpanded));
                    elements.howToContent.classList.toggle('d-none', isExpanded);
                    const iconElement = elements.howToToggleBtn.querySelector('i');
                    if (iconElement) {
                        iconElement.setAttribute('data-feather', !isExpanded ? 'chevron-down' : 'help-circle');
                        _replaceFeatherIcons([iconElement]);
                    }
                });
                const howToIcons = elements.howToContent.querySelectorAll('i[data-feather]');
                if (howToIcons.length > 0) _replaceFeatherIcons(howToIcons);
            }

            updateStatus('Trainer Ready. Click "Start Call" to begin.', 'info');
            if (elements.startCallBtn) elements.startCallBtn.disabled = false;
            if (elements.recordBtn) elements.recordBtn.disabled = true;
            if (elements.endCallBtn) elements.endCallBtn.disabled = true;

            addMessageToTranscript('System', 'Welcome! Click "Start Call" to begin your AI training session.', 'system');

            showToast("AI Sales Pro 4.0 Ready!", "success", 2000);
            logDebug("Initialization complete.", 'success');
            if (appState.showDebug && elements.debugConsole) {
                elements.debugConsole.style.display = 'block';
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTrainer);
        } else {
            initializeTrainer();
        }
    </script>
</body>
</html>